<!--pages/dynamic-crud-test/dynamic-crud-test.wxml-->
<view class="dynamic-test-container">
  <!-- 页面标题 -->
  <view class="page-header">
    <text class="page-title">⚡ 动态CRUD测试</text>
    <text class="page-subtitle">实时交互式数据库测试</text>
    <text class="connection-status {{connectionStatus}}">{{connectionStatusText}}</text>
  </view>

  <!-- 快速操作区域 -->
  <view class="quick-actions">
    <button 
      class="action-btn primary" 
      bindtap="testConnection"
      disabled="{{isLoading}}"
      loading="{{isLoading && activeTab === 'connection'}}">
      🔗 测试连接
    </button>
    <button 
      class="action-btn secondary" 
      bindtap="runFullDynamicTest"
      disabled="{{!isConnected || isLoading}}"
      loading="{{isLoading && activeTab === 'batch'}}">
      🚀 一键测试
    </button>
    <button 
      class="action-btn secondary" 
      bindtap="clearLogs"
      disabled="{{isLoading}}">
      🧹 清空日志
    </button>
  </view>

  <!-- 主要内容区域 -->
  <view class="main-content">
    <!-- 左侧：用户列表 -->
    <view class="users-panel">
      <view class="panel-header">
        <text class="panel-title">👥 用户列表</text>
        <button 
          class="refresh-btn" 
          bindtap="refreshUsers"
          disabled="{{!isConnected || isLoading}}">
          🔄
        </button>
      </view>
      
      <scroll-view scroll-y class="users-list">
        <view class="user-item {{currentUser && currentUser.id === item.id ? 'active' : ''}}" 
              wx:for="{{testUsers}}" 
              wx:key="id"
              data-user="{{item}}"
              bindtap="selectCurrentUser">
          <view class="user-avatar">
            <image src="{{item.avatar_url || item.avatarUri || '/images/default-avatar.png'}}" 
                   mode="aspectFill"/>
          </view>
          <view class="user-info">
            <text class="user-name">{{item.nickname || item.nickName || '未命名用户'}}</text>
            <text class="user-id">ID: {{item.id}}</text>
            <text class="user-openid">OpenID: {{item.openid}}</text>
          </view>
          <view class="user-actions">
            <button 
              class="mini-btn edit" 
              data-user="{{item}}"
              catchtap="quickUpdateCurrentUser">
              ✏️
            </button>
            <button 
              class="mini-btn delete" 
              data-user="{{item}}"
              catchtap="quickDeleteCurrentUser">
              🗑️
            </button>
          </view>
        </view>
        
        <view class="empty-state" wx:if="{{testUsers.length === 0}}">
          <text class="empty-text">暂无用户数据</text>
          <text class="empty-hint">点击"测试连接"或创建新用户</text>
        </view>
      </scroll-view>
    </view>

    <!-- 右侧：操作区域 -->
    <view class="operations-panel">
      <!-- 创建用户表单 -->
      <view class="create-user-section">
        <view class="section-header">
          <text class="section-title">➕ 创建新用户</text>
          <button 
            class="generate-btn" 
            bindtap="generateNewTestData"
            disabled="{{isLoading}}">
            🎲
          </button>
        </view>
        
        <view class="form-group">
          <text class="form-label">OpenID:</text>
          <input class="form-input" 
                 value="{{createForm.openid}}" 
                 data-field="openid"
                 bindinput="onFormInput"
                 placeholder="自动生成，可修改"
                 disabled="{{isLoading}}"/>
        </view>
        
        <view class="form-group">
          <text class="form-label">用户ID:</text>
          <input class="form-input" 
                 value="{{createForm.user_id}}" 
                 data-field="user_id"
                 bindinput="onFormInput"
                 placeholder="自动生成，可修改"
                 disabled="{{isLoading}}"/>
        </view>
        
        <view class="form-group">
          <text class="form-label">昵称:</text>
          <input class="form-input" 
                 value="{{createForm.nickname}}" 
                 data-field="nickname"
                 bindinput="onFormInput"
                 placeholder="输入用户昵称"
                 disabled="{{isLoading}}"/>
        </view>
        
        <view class="form-group">
          <text class="form-label">头像URL:</text>
          <input class="form-input" 
                 value="{{createForm.avatar_url}}" 
                 data-field="avatar_url"
                 bindinput="onFormInput"
                 placeholder="头像URL"
                 disabled="{{isLoading}}"/>
        </view>
        
        <button 
          class="create-btn primary" 
          bindtap="createUser"
          disabled="{{!isConnected || isLoading}}"
          loading="{{isLoading}}">
          创建用户
        </button>
      </view>

      <!-- 当前用户操作 -->
      <view class="current-user-section" wx:if="{{currentUser}}">
        <view class="section-header">
          <text class="section-title">🎯 当前用户: {{currentUser.nickname}}</text>
        </view>
        
        <view class="current-user-info">
          <text class="info-item">ID: {{currentUser.id}}</text>
          <text class="info-item">OpenID: {{currentUser.openid}}</text>
          <text class="info-item">创建时间: {{currentUser.created_at}}</text>
        </view>
        
        <view class="user-action-buttons">
          <button 
            class="action-btn secondary" 
            bindtap="quickUpdateCurrentUser"
            disabled="{{isLoading}}">
            ✏️ 快速更新
          </button>
          <button 
            class="action-btn danger" 
            bindtap="quickDeleteCurrentUser"
            disabled="{{isLoading}}">
            🗑️ 删除用户
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- 操作日志 -->
  <view class="logs-section">
    <view class="logs-header">
      <text class="logs-title">📋 操作日志</text>
      <view class="logs-controls">
        <button 
          class="mini-btn" 
          bindtap="clearLogs"
          disabled="{{isLoading}}">
          🧹
        </button>
      </view>
    </view>
    
    <scroll-view scroll-y class="logs-container">
      <view class="log-item" wx:for="{{operationLogs}}" wx:key="id" style="border-left-color: {{item.color}};">
        <view class="log-header">
          <text class="log-operation">{{item.operation}}</text>
          <text class="log-status" style="color: {{item.color}};">{{item.status}}</text>
          <text class="log-time">{{item.timestamp}}</text>
        </view>
        <text class="log-message">{{item.message}}</text>
        <text class="log-data" wx:if="{{item.data}}">{{item.data}}</text>
      </view>
      
      <view class="empty-logs" wx:if="{{operationLogs.length === 0}}">
        <text class="empty-text">暂无操作日志</text>
        <text class="empty-hint">执行操作后将显示日志</text>
      </view>
    </scroll-view>
  </view>
</view>