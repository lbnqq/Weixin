<!--pages/dynamic-crud-test/dynamic-crud-test.wxml-->
<view class="dynamic-test-container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-header">
    <text class="page-title">âš¡ åŠ¨æ€CRUDæµ‹è¯•</text>
    <text class="page-subtitle">å®æ—¶äº¤äº’å¼æ•°æ®åº“æµ‹è¯•</text>
    <text class="connection-status {{connectionStatus}}">{{connectionStatusText}}</text>
  </view>

  <!-- å¿«é€Ÿæ“ä½œåŒºåŸŸ -->
  <view class="quick-actions">
    <button 
      class="action-btn primary" 
      bindtap="testConnection"
      disabled="{{isLoading}}"
      loading="{{isLoading && activeTab === 'connection'}}">
      ğŸ”— æµ‹è¯•è¿æ¥
    </button>
    <button 
      class="action-btn secondary" 
      bindtap="runFullDynamicTest"
      disabled="{{!isConnected || isLoading}}"
      loading="{{isLoading && activeTab === 'batch'}}">
      ğŸš€ ä¸€é”®æµ‹è¯•
    </button>
    <button 
      class="action-btn secondary" 
      bindtap="clearLogs"
      disabled="{{isLoading}}">
      ğŸ§¹ æ¸…ç©ºæ—¥å¿—
    </button>
  </view>

  <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
  <view class="main-content">
    <!-- å·¦ä¾§ï¼šç”¨æˆ·åˆ—è¡¨ -->
    <view class="users-panel">
      <view class="panel-header">
        <text class="panel-title">ğŸ‘¥ ç”¨æˆ·åˆ—è¡¨</text>
        <button 
          class="refresh-btn" 
          bindtap="refreshUsers"
          disabled="{{!isConnected || isLoading}}">
          ğŸ”„
        </button>
      </view>
      
      <scroll-view scroll-y class="users-list">
        <view class="user-item {{currentUser && currentUser.id === item.id ? 'active' : ''}}" 
              wx:for="{{testUsers}}" 
              wx:key="id"
              data-user="{{item}}"
              bindtap="selectCurrentUser">
          <view class="user-avatar">
            <image src="{{item.avatar_url || item.avatarUri || '/images/default-avatar.png'}}" 
                   mode="aspectFill"/>
          </view>
          <view class="user-info">
            <text class="user-name">{{item.nickname || item.nickName || 'æœªå‘½åç”¨æˆ·'}}</text>
            <text class="user-id">ID: {{item.id}}</text>
            <text class="user-openid">OpenID: {{item.openid}}</text>
          </view>
          <view class="user-actions">
            <button 
              class="mini-btn edit" 
              data-user="{{item}}"
              catchtap="quickUpdateCurrentUser">
              âœï¸
            </button>
            <button 
              class="mini-btn delete" 
              data-user="{{item}}"
              catchtap="quickDeleteCurrentUser">
              ğŸ—‘ï¸
            </button>
          </view>
        </view>
        
        <view class="empty-state" wx:if="{{testUsers.length === 0}}">
          <text class="empty-text">æš‚æ— ç”¨æˆ·æ•°æ®</text>
          <text class="empty-hint">ç‚¹å‡»"æµ‹è¯•è¿æ¥"æˆ–åˆ›å»ºæ–°ç”¨æˆ·</text>
        </view>
      </scroll-view>
    </view>

    <!-- å³ä¾§ï¼šæ“ä½œåŒºåŸŸ -->
    <view class="operations-panel">
      <!-- åˆ›å»ºç”¨æˆ·è¡¨å• -->
      <view class="create-user-section">
        <view class="section-header">
          <text class="section-title">â• åˆ›å»ºæ–°ç”¨æˆ·</text>
          <button 
            class="generate-btn" 
            bindtap="generateNewTestData"
            disabled="{{isLoading}}">
            ğŸ²
          </button>
        </view>
        
        <view class="form-group">
          <text class="form-label">OpenID:</text>
          <input class="form-input" 
                 value="{{createForm.openid}}" 
                 data-field="openid"
                 bindinput="onFormInput"
                 placeholder="è‡ªåŠ¨ç”Ÿæˆï¼Œå¯ä¿®æ”¹"
                 disabled="{{isLoading}}"/>
        </view>
        
        <view class="form-group">
          <text class="form-label">ç”¨æˆ·ID:</text>
          <input class="form-input" 
                 value="{{createForm.user_id}}" 
                 data-field="user_id"
                 bindinput="onFormInput"
                 placeholder="è‡ªåŠ¨ç”Ÿæˆï¼Œå¯ä¿®æ”¹"
                 disabled="{{isLoading}}"/>
        </view>
        
        <view class="form-group">
          <text class="form-label">æ˜µç§°:</text>
          <input class="form-input" 
                 value="{{createForm.nickname}}" 
                 data-field="nickname"
                 bindinput="onFormInput"
                 placeholder="è¾“å…¥ç”¨æˆ·æ˜µç§°"
                 disabled="{{isLoading}}"/>
        </view>
        
        <view class="form-group">
          <text class="form-label">å¤´åƒURL:</text>
          <input class="form-input" 
                 value="{{createForm.avatar_url}}" 
                 data-field="avatar_url"
                 bindinput="onFormInput"
                 placeholder="å¤´åƒURL"
                 disabled="{{isLoading}}"/>
        </view>
        
        <button 
          class="create-btn primary" 
          bindtap="createUser"
          disabled="{{!isConnected || isLoading}}"
          loading="{{isLoading}}">
          åˆ›å»ºç”¨æˆ·
        </button>
      </view>

      <!-- å½“å‰ç”¨æˆ·æ“ä½œ -->
      <view class="current-user-section" wx:if="{{currentUser}}">
        <view class="section-header">
          <text class="section-title">ğŸ¯ å½“å‰ç”¨æˆ·: {{currentUser.nickname}}</text>
        </view>
        
        <view class="current-user-info">
          <text class="info-item">ID: {{currentUser.id}}</text>
          <text class="info-item">OpenID: {{currentUser.openid}}</text>
          <text class="info-item">åˆ›å»ºæ—¶é—´: {{currentUser.created_at}}</text>
        </view>
        
        <view class="user-action-buttons">
          <button 
            class="action-btn secondary" 
            bindtap="quickUpdateCurrentUser"
            disabled="{{isLoading}}">
            âœï¸ å¿«é€Ÿæ›´æ–°
          </button>
          <button 
            class="action-btn danger" 
            bindtap="quickDeleteCurrentUser"
            disabled="{{isLoading}}">
            ğŸ—‘ï¸ åˆ é™¤ç”¨æˆ·
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- æ“ä½œæ—¥å¿— -->
  <view class="logs-section">
    <view class="logs-header">
      <text class="logs-title">ğŸ“‹ æ“ä½œæ—¥å¿—</text>
      <view class="logs-controls">
        <button 
          class="mini-btn" 
          bindtap="clearLogs"
          disabled="{{isLoading}}">
          ğŸ§¹
        </button>
      </view>
    </view>
    
    <scroll-view scroll-y class="logs-container">
      <view class="log-item" wx:for="{{operationLogs}}" wx:key="id" style="border-left-color: {{item.color}};">
        <view class="log-header">
          <text class="log-operation">{{item.operation}}</text>
          <text class="log-status" style="color: {{item.color}};">{{item.status}}</text>
          <text class="log-time">{{item.timestamp}}</text>
        </view>
        <text class="log-message">{{item.message}}</text>
        <text class="log-data" wx:if="{{item.data}}">{{item.data}}</text>
      </view>
      
      <view class="empty-logs" wx:if="{{operationLogs.length === 0}}">
        <text class="empty-text">æš‚æ— æ“ä½œæ—¥å¿—</text>
        <text class="empty-hint">æ‰§è¡Œæ“ä½œåå°†æ˜¾ç¤ºæ—¥å¿—</text>
      </view>
    </scroll-view>
  </view>
</view>